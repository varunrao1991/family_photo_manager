<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Similarity Search</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        h1 {
            text-align: center;
        }
        label {
            display: block;
            margin-top: 20px;
        }
        input[type="file"] {
            margin-top: 10px;
        }
        #results {
            margin-top: 20px;
        }
        .card-img-top {
            max-height: 300px;
            object-fit: cover;
        }
        .button-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        .button-container .btn {
            margin-left: 10px;
        }
        .loading {
            text-align: center;
            margin: 20px;
        }
        .pagination {
            justify-content: center; /* Center align pagination */
        }
    </style>
</head>
<body>
    <h1>Image Similarity Search</h1>
    <form id="searchForm" enctype="multipart/form-data">
        <label for="query_text">Enter Text Prompt:</label>
        <input type="text" id="query_text" name="query_text" class="form-control">
        
        <label for="query_image">Or Upload an Image:</label>
        <input type="file" id="query_image" name="query_image" accept="image/*" class="form-control">
        
        <button type="submit" class="btn btn-primary mt-3">Search</button>
    </form>
    
    <div class="button-container">
        <button id="selectAll" class="btn btn-secondary" disabled>Select All</button>
        <button id="deleteSelected" class="btn btn-danger" disabled>Delete Selected</button>
    </div>
    
    <div id="results" class="row">
        <!-- Results will be displayed here -->
    </div>

    <div class="loading" id="loading" style="display: none;">
        <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
    
    <nav aria-label="Page navigation">
        <ul class="pagination">
            <li class="page-item">
                <button id="prevPage" class="page-link" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </button>
            </li>
            <li class="page-item">
                <span id="pageInfo" class="page-link">Page 1</span>
            </li>
            <li class="page-item">
                <button id="nextPage" class="page-link" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </button>
            </li>
        </ul>
    </nav>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let currentPage = 1;
        const perPage = 50;

        document.getElementById('searchForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            currentPage = 1; // Reset to first page on new search
            loadPage();
        });

        document.getElementById('prevPage').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                loadPage();
            }
        });

        document.getElementById('nextPage').addEventListener('click', function() {
            currentPage++;
            loadPage();
        });

        function loadPage() {
            document.getElementById('loading').style.display = 'block';
            const formData = new FormData(document.getElementById('searchForm'));
            formData.append('page', currentPage);
            formData.append('per_page', perPage);
            
            fetch('/similar-images', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                displayImages(data);
                updatePageInfo();
                document.getElementById('loading').style.display = 'none';
            });
        }

        function displayImages(data) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            if (data.similar_images && data.similar_images.length > 0) {
                data.similar_images.forEach(imagePath => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'col-md-4 mb-3'; // Ensure 3 cards per row
                    
                    const card = document.createElement('div');
                    card.className = 'card';
                    
                    const imgElement = document.createElement('img');
                    imgElement.src = `/images/${imagePath}`;
                    imgElement.className = 'card-img-top';
                    imgElement.alt = 'Similar Image';
                    imgElement.loading = 'lazy'; // Lazy load the image

                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'card-checkbox';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = imagePath;
                    
                    checkboxDiv.appendChild(checkbox);

                    const cardBody = document.createElement('div');
                    cardBody.className = 'card-body';
                    cardBody.appendChild(checkboxDiv);
                    
                    card.appendChild(imgElement);
                    card.appendChild(cardBody);
                    cardDiv.appendChild(card);
                    resultsDiv.appendChild(cardDiv);
                });

                document.getElementById('selectAll').disabled = false;
                document.getElementById('deleteSelected').disabled = false;
            } else {
                resultsDiv.textContent = 'No similar images found.';
                document.getElementById('selectAll').disabled = true;
                document.getElementById('deleteSelected').disabled = true;
            }
        }

        function updatePageInfo() {
            document.getElementById('pageInfo').textContent = `Page ${currentPage}`;
        }

        document.getElementById('selectAll').addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('#results .card-checkbox input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        });

        document.getElementById('deleteSelected').addEventListener('click', async function() {
            const checkboxes = document.querySelectorAll('#results .card-checkbox input[type="checkbox"]:checked');
            const selectedPaths = Array.from(checkboxes).map(checkbox => checkbox.value);
            
            if (selectedPaths.length > 0) {
                const response = await fetch('/delete-images', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ images: selectedPaths })
                });
                
                const result = await response.json();
                alert(result.message);
                
                // Remove the deleted images from the GUI
                selectedPaths.forEach(path => {
                    const imgElements = document.querySelectorAll(`#results .card-checkbox input[value="${path}"]`);
                    imgElements.forEach(imgElement => imgElement.closest('.card').remove());
                });
                // Disable buttons if no images left
                if (document.querySelectorAll('#results .card').length === 0) {
                    document.getElementById('selectAll').disabled = true;
                    document.getElementById('deleteSelected').disabled = true;
                }
            } else {
                alert('No images selected.');
            }
        });

        document.getElementById('results').addEventListener('change', function() {
            const selectedCheckboxes = document.querySelectorAll('#results .card-checkbox input[type="checkbox"]:checked').length;
            document.getElementById('deleteSelected').disabled = selectedCheckboxes === 0;
        });
    </script>
</body>
</html>
